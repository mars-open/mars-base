dataObjects {

  # geopackage doesnt work, error because of null values in Date column
  #java.lang.NullPointerException: text
  #at java.util.Objects.requireNonNull(Objects.java:235) ~[?:?]
  #at java.time.format.DateTimeFormatter.parse(DateTimeFormatter.java:1951) ~[?:?]
  #at java.time.LocalDate.parse(LocalDate.java:430) ~[?:?]
  #at org.apache.sedona.sql.datasources.geopackage.transform.DataTypesTransformations$.getDays(DataTypesTransformations.scala:37) ~[sedona-spark-common-3.5_2.13-1.8.0.jar:1.8.0]
  #at org.apache.sedona.sql.datasources.geopackage.transform.ValuesMapper$.$anonfun$mapValues$1(ValuesMapper.scala:56) ~[sedona-spark-common-3.5_2.13-1.8.0.jar:1.8.0]
  #ext-tlm3d-track {
  #  type = RawFileDataObject
  #  path = "./data/ext/tlm3d/SWISSTLM3D_2025.gpkg"
  #  customFormat = geopackage
  #  options {
  #    tableName = "tlm_oev_eisenbahn"
  #  }
  #}

  # geoparquet is ok
  ext-tlm3d-track {
    type = RawFileDataObject
    path = "./data/ext/tlm3d/track"
    customFormat = geoparquet
  }

  ext-tlm3d-ocp {
    type = RawFileDataObject
    path = "./data/ext/tlm3d/ocp"
    customFormat = geoparquet
  }

  slv-tlm3d-ocp = ${templates.slvTable} {
    path = tlm3d_ocp
  }

  slv-tlm3d-track = ${templates.slvTable} {
    path = tlm3d_track
  }

  slv-tlm3d-edge = ${templates.slvTable} {
    path = tlm3d_edge
  }

  slv-tlm3d-node = ${templates.slvTable} {
    path = tlm3d_node
  }

  slv-tlm3d-pp = ${templates.slvTable} {
    path = tlm3d_pp
    schema = "caseClass#ch.zzeekk.mars.pp.RawPpWithMapping"
  }

}

actions {

  load-slv-ocp {
    type = CopyAction
    inputId = ext-tlm3d-ocp
    outputId = slv-tlm3d-ocp
    transformers = [{
      type = SQLDfTransformer
      code = """
        SELECT
          uuid,
          cast(datum_aenderung as date) AS changed,
          cast(datum_erstellung as date) AS created,
          name,
          cast(dienststellen_nummer as int) AS number,
          geometry
        FROM %{inputViewName}
        WHERE objektart = 'Haltestelle Bahn';
      """
    }]
    metadata.feed = tlm3d-ext
  }

  load-slv-tlm3d-track {
    type = CopyAction
    inputId = ext-tlm3d-track
    outputId = slv-tlm3d-track
    transformers = [{
      type = SQLDfTransformer
      code = """
        SELECT
          lower(regexp_replace(uuid, '\\{|\\}', '')) AS uuid,
          CAST(datum_aenderung AS DATE) AS changed,
          CAST(datum_erstellung AS DATE) AS created,
          objektart AS type,
          verkehrsmittel AS subtype,
          NOT (LOWER(anschlussgleis) = 'wahr') AS main,
          CASE
            WHEN LOWER(kunstbaute) <> 'keine' THEN kunstbaute
            ELSE NULL
          END AS structure,
          tlm_oev_name_uuid AS structure_uuid,
          name AS structure_name,
          stufe AS stufe,
          (LOWER(museumsbahn) = 'wahr') AS museumsbahn,
          (LOWER(zahnradbahn) = 'wahr') AS zahnradbahn,
          (LOWER(standseilbahn) = 'wahr') AS standseilbahn,
          (LOWER(betriebsbahn) = 'wahr') AS betriebsbahn,
          (LOWER(achse_dkm) = 'wahr') AS achse_dkm,
          CAST(anzahl_spuren AS SMALLINT) AS nb_of_tracks,
          geometry
        FROM %{inputViewName}
        WHERE ausser_betrieb IS NULL OR LOWER(ausser_betrieb) <> 'wahr';
      """
    }]
    metadata.feed = tlm3d-ext
  }

  create-slv-tlm3d-edge {
    type = CustomDataFrameAction
    inputIds = [slv-tlm3d-track]
    outputIds = [slv-tlm3d-edge]
    transformers = [{
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.ch.tlm3d.Tlm3dEdgeInputTransformer
      overrideOutputId = "track"
    }, {
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.pp.EdgeTransformer
      options = {
        trackUuidsToExcludeFromMerge = "ef9d8e6b-7896-4eab-9675-f78c93ea4493,a720d721-bf2a-4042-bb47-4f8105bad9aa,ec861df3-38cb-4cb8-8f4b-3bcecc997708" // circular tracks...
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = tlm3d
  }

  create-slv-tlm3d-node {
    type = CustomDataFrameAction
    inputIds = [slv-tlm3d-edge]
    outputIds = [slv-tlm3d-node]
    transformers = [{
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.pp.NodeTransformer
      renamedInputIds = {
        slv-tlm3d-edge: edge
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = tlm3d
  }

  create-slv-tlm3d-pp {
    type = CustomDataFrameAction
    inputIds = [slv-tlm3d-edge, slv-tlm3d-node]
    outputIds = [slv-tlm3d-pp]
    transformers = [{
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.pp.CreatePpTransformer
      renamedInputIds = {
        slv-tlm3d-edge = edge
        slv-tlm3d-node = node
      }
      options = {
        srcCrs = ${parameters.defaultSrcCrs}
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = tlm3d
  }

}