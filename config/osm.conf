
dataObjects {

  ext-osm-track {
    type = JsonFileDataObject
    path = "./data/ext/osm/"${parameters.osmConfig.region}"-railway-tracks.jsons"
    schema = "caseClass#ch.zzeekk.mars.osm.RawTrack"
    jsonOptions = {
      mode = FAILFAST
      multiline = false
    }
    metadata.description = """
      OSM railway tracks, extracted from the dump downloaded from  https://download.geofabrik.de/europe and preprocessed using osmium.
      See https://taginfo.geofabrik.de/ for more informations about used properties.
    """
  }

  slv-osm-track = ${templates.slvTable} {
    path = osm_track
  }

  slv-osm-edge = ${templates.slvTable} {
    path = osm_edge
  }

  slv-osm-node = ${templates.slvTable} {
    path = osm_node
  }

  slv-osm-pp = ${templates.slvTable} {
    path = osm_pp
    schema = "caseClass#ch.zzeekk.mars.pp.RawPpWithMapping"
  }

  gld-osm-node-fgb = {
    type = ch.zzeekk.mars.pp.FlatGeobufDataObject
    localPath = "./data/gld/geometries/"${parameters.countryCode}"-osm-node.fgb"
    path = ${env.geometriesPath}/${parameters.countryCode}"-osm-node.fgb"
  }

  gld-osm-edge-fgb = {
    type = ch.zzeekk.mars.pp.FlatGeobufDataObject
    localPath = "./data/gld/geometries/"${parameters.countryCode}"-osm-edge.fgb"
    path = ${env.geometriesPath}/${parameters.countryCode}"-osm-edge.fgb"
    colsToIgnore = [tracks]
  }

  gld-osm-line-fgb = {
    type = ch.zzeekk.mars.pp.FlatGeobufDataObject
    geometryType = "MultiLineString"
    localPath = "./data/gld/geometries/"${parameters.countryCode}"-osm-line.fgb"
    path = ${env.geometriesPath}/${parameters.countryCode}"-osm-line.fgb"
  }

}

actions {

  load-slv-osm-track {
    type = CopyAction
    inputId = ext-osm-track
    outputId = slv-osm-track
    transformers = [{
      type = SQLDfTransformer
      code = """
        SELECT
          udfUuidFromString(geometry) as uuid,
          ST_GeomFromGeoJSON(geometry) geometry,
          properties.ref as ref,
          properties.track_ref as track_ref,
          properties.usage = 'main' as main,
          properties.maxspeed,
          properties.operator,
          properties.railway as type
        FROM %{inputViewName}
      """
    }]
    metadata.feed = osm-ext
  }

  create-slv-osm-edge {
    type = CustomDataFrameAction
    inputIds = [slv-osm-track]
    outputIds = [slv-osm-edge]
    transformers = [{
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.osm.OsmTrackTransformer
    }, {
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.pp.EdgeTransformer
      options = {
        trackUuidsToExcludeFromMerge = "e9663bfd-4e7e-3cdc-9a00-526be4d00f93,88263045-bbc5-3eec-a471-5cb3b8094ff3,036832b6-c6d6-35d4-934b-441605a17a3d,db5cfeeb-8263-3c06-b4b7-0dbdadc09503,b1309a27-f37c-3cb8-bc80-2496ac652a8f,4934cd70-a2c6-39e5-abc8-83899b9f10ea" // circular tracks...
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = osm
  }

  create-slv-osm-node {
    type = CustomDataFrameAction
    inputIds = [slv-osm-edge]
    outputIds = [slv-osm-node]
    transformers = [{
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.pp.NodeTransformer
      renamedInputIds = {
        slv-osm-edge: edge
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = osm
  }

  create-slv-osm-pp {
    type = CustomDataFrameAction
    inputIds = [slv-osm-edge, slv-osm-node]
    outputIds = [slv-osm-pp]
    transformers = [{
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.pp.CreatePpTransformer
      renamedInputIds = {
        slv-osm-edge = edge
        slv-osm-node = node
      }
      options = {
        srcCrs = "EPSG:4326"
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = osm
  }

  load-gld-osm-node-fgb {
    type = CopyAction
    inputId = slv-osm-node
    outputId = gld-osm-node-fgb
    metadata.feed = osm
  }

  load-gld-osm-edge-fgb {
    type = CopyAction
    inputId = slv-osm-edge
    outputId = gld-osm-edge-fgb
    metadata.feed = osm
  }

  load-gld-osm-line-fgb {
    type = CopyAction
    inputId = ext-osm-track
    outputId = gld-osm-line-fgb
    transformers = [{
      type = ScalaClassSparkDfTransformer
      className = ch.zzeekk.mars.osm.OsmExtractMainRailwayLinesTransformer
      options = {
        operators = ${parameters.osmConfig.lineExtract.operators}
        linesToExclude = ${?parameters.osmConfig.lineExtract.linesToExclude}
      }
    }]
    metadata.feed = osm
  }

}