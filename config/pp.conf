dataObjects {

  slv-pp = {
    type = DeltaLakeTableDataObject
    table = {
      db = default
      name = slv_pp
    }
    path = "./data/slv/pp"
    saveMode = Append
    schemaMin = "caseClass#ch.zzeekk.mars.pp.Pp" # needed because used as recursive input
  }

  slv-pp-tlm3d = {
    type = DeltaLakeTableDataObject
    table = {
      db = default
      name = slv_pp_tlm3d
    }
    path = "./data/slv/pp_tlm3d"
  }

  gld-edge = {
    type = RawFileDataObject
    path = "./data/gld/edge"
    customFormat = geoparquet
  }

  gld-edge-fgb = {
    type = ch.zzeekk.mars.pp.FlatGeobufDataObject
    localPath = "./data/gld/geometries/edges.fgb"
    colsToIgnore = [tracks]
  }

  gld-node = {
    type = RawFileDataObject
    path = "./data/gld/node"
    customFormat = geoparquet
  }

  gld-node-fgb = {
    type = ch.zzeekk.mars.pp.FlatGeobufDataObject
    localPath = "./data/gld/geometries/nodes.fgb"
    geometryType = Point
    #idColName = uuid_node # doesnt work in version 33.1, lets put it as attribute
    colsToIgnore = [edges]
    ogr2OgrFix = true # otherwise error "start offset of Float64Array should be a multiple of 8" might occur in JS clients...
  }

  gld-pp-tlm3d = {
    type = RawFileDataObject
    path = "./data/gld/pp-tlm3d"
    customFormat = geoparquet
  }

  gld-pp-tlm3d-pmtiles = {
    type = ch.zzeekk.mars.pp.PMTilesDataObject
    localPath = "./data/gld/geometries/pp.raw.pmtiles"
    compressTiles = false
    zoomAndFilter = {
      15 = "zoom <= 1"
      18 = "zoom <= 2"
      21 = "zoom <= 3"
    }
  }
}

actions {

  create-pp {
    type = CustomDataFrameAction
    inputIds = [slv-tlm3d-pp]
    outputIds = [slv-pp, slv-pp-tlm3d]
    recursiveInputIds = [slv-pp]
    transformers = [{
      type = ScalaClassSparkDfsTransformer
      className = ch.zzeekk.mars.pp.SnapPpTransformer
      options = {
        srcCrs = "EPSG:2056"
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = pp
  }

  load-gld-edge {
    type = CopyAction
    inputId = slv-tlm3d-edge
    outputId = gld-edge
    metadata.feed = gld
  }

  load-gld-node {
    type = CopyAction
    inputId = slv-tlm3d-node
    outputId = gld-node
    metadata.feed = gld
  }

  load-gld-edge-fgb {
    type = CopyAction
    inputId = slv-tlm3d-edge
    outputId = gld-edge-fgb
    transformers = [{
      type = ScalaClassSparkDfTransformer
      className = ch.zzeekk.mars.pp.CrsTransformer
      options {
        srcCrs = "EPSG:2056"
        tgtCrs = "EPSG:4326"
      }
    }]
    metadata.feed = gld
  }

  load-gld-node-fgb {
    type = CopyAction
    inputId = slv-tlm3d-node
    outputId = gld-node-fgb
    transformers = [{
      type = ScalaClassSparkDfTransformer
      className = ch.zzeekk.mars.pp.CrsTransformer
      options {
        srcCrs = "EPSG:2056"
        tgtCrs = "EPSG:4326"
      }
    }]
    metadata.feed = gld
  }

  load-gld-pp {
    type = CustomDataFrameAction
    inputIds = [slv-pp, slv-pp-tlm3d, slv-tlm3d-pp]
    outputIds = [gld-pp-tlm3d]
    transformers = [{
      type = SQLDfsTransformer
      code {
        gld-pp-tlm3d = """
          select
            ST_PointZ(pp.x,pp.y,pp.z) as geometry,
            pp.id_positionpoint, pp.token, pp.zoom,
            ppm.uuid_edge, ppm.position, ppm.direction,
            tlm3d.azimuth,
            tlm3d.radius * ppm.direction as radius,
            tlm3d.grade * ppm.direction as grade,
            tlm3d.tags
          from %{inputViewName_slv-pp} pp
          join %{inputViewName_slv-pp-tlm3d} ppm using (id_positionpoint, zoom)
          left join %{inputViewName_slv-tlm3d-pp} tlm3d using (uuid_edge, edge_idx)
        """
      }
    }]
    breakDataFrameLineage = true
    metadata {
      feed = gld
    }
  }
  load-gld-pp-pmtiles {
    type = CustomDataFrameAction
    inputIds = [slv-pp, slv-pp-tlm3d, slv-tlm3d-pp]
    outputIds = [gld-pp-tlm3d-pmtiles]
    transformers = [{
      type = SQLDfsTransformer
      code {
        gld-pp-tlm3d-pmtiles = """
          select
            ST_PointZ(pp.lng,pp.lat,pp.z) as geometry,
            pp.id_positionpoint, pp.token, pp.zoom,
            ppm.uuid_edge, ppm.position, ppm.direction,
            tlm3d.azimuth,
            tlm3d.radius * ppm.direction as radius,
            tlm3d.grade * ppm.direction as grade,
            tlm3d.tags,
            'pps' as layer
          from %{inputViewName_slv-pp} pp
          join %{inputViewName_slv-pp-tlm3d} ppm using (id_positionpoint, zoom)
          left join %{inputViewName_slv-tlm3d-pp} tlm3d using (uuid_edge, edge_idx)
        """
      }
    }]
    breakDataFrameLineage = true
    metadata {
      feed = gld
      description = "Creates a pmtiles file, around 5GB size, takes 15min."
    }
  }

}