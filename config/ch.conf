// chosen parameter config in global.conf!
parametersCH {
  countryCode = "ch"
  defaultSrcCrs = "EPSG:2056"
  topology = "tlm3d"
  osmConfig {
    region = "switzerland"
    lineExtract = {
      operators = "SBB,BLS"
      #linesToExclude = "300,302"
    }
  }
}

dataObjects {

  gld-ch-edge = {
    type = RawFileDataObject
    path = "./data/gld/ch-edge"
    customFormat = geoparquet
  }

  gld-ch-edge-fgb = {
    type = ch.zzeekk.mars.pp.FlatGeobufDataObject
    localPath = "./data/gld/geometries/ch-edges.fgb"
    path = ${env.geometriesPath}"/ch-edges.fgb"
    colsToIgnore = [tracks]
  }

  gld-ch-node = {
    type = RawFileDataObject
    path = "./data/gld/ch-node"
    customFormat = geoparquet
  }

  gld-ch-node-fgb = {
    type = ch.zzeekk.mars.pp.FlatGeobufDataObject
    localPath = "./data/gld/geometries/ch-nodes.fgb"
    path = ${env.geometriesPath}"/ch-nodes.fgb"
    geometryType = Point
    #idColName = uuid_node # doesnt work in version 33.1, lets put it as attribute
    colsToIgnore = [edges]
    ogr2OgrFix = true # otherwise error "start offset of Float64Array should be a multiple of 8" might occur in JS clients...
  }

  gld-ch-pp-raw-pmtiles = {
    type = ch.zzeekk.mars.pp.PMTilesDataObject
    localPath = "./data/gld/geometries/ch-pp-raw.pmtiles"
    path = ${env.geometriesPath}"/ch-pp-raw.pmtiles"
    compressTiles = false
    zoomAndFilter = {
      15 = "zoom <= 1"
      18 = "zoom <= 2"
      21 = "zoom <= 3"
    }
  }

  gld-ch-pp = {
    type = RawFileDataObject
    path = "./data/gld/ch-pp"
    customFormat = geoparquet
  }

  gld-ch-pp-pmtiles = {
    type = ch.zzeekk.mars.pp.PMTilesDataObject
    localPath = "./data/gld/geometries/ch-pp.pmtiles"
    path = ${env.geometriesPath}"/ch-pp.pmtiles"
    compressTiles = false
    zoomAndFilter = {
      15 = "zoom <= 1"
      18 = "zoom <= 2"
      21 = "zoom <= 3"
    }
  }

}

actions {

  load-gld-ch-edge {
    type = CopyAction
    inputId = slv-tlm3d-edge
    outputId = gld-ch-edge
    breakDataFrameLineage = true
    metadata.feed = ch
  }

  load-gld-ch-node {
    type = CopyAction
    inputId = slv-tlm3d-node
    outputId = gld-ch-node
    breakDataFrameLineage = true
    metadata.feed = ch
  }

  load-gld-ch-edge-fgb {
    type = CopyAction
    inputId = slv-tlm3d-edge
    outputId = gld-ch-edge-fgb
    transformers = [{
      type = ScalaClassSparkDfTransformer
      className = ch.zzeekk.mars.pp.CrsTransformer
      options {
        srcCrs = ${parameters.defaultSrcCrs}
        tgtCrs = "EPSG:4326"
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = ch
  }

  load-gld-ch-node-fgb {
    type = CopyAction
    inputId = slv-tlm3d-node
    outputId = gld-ch-node-fgb
    transformers = [{
      type = ScalaClassSparkDfTransformer
      className = ch.zzeekk.mars.pp.CrsTransformer
      options {
        srcCrs = ${parameters.defaultSrcCrs}
        tgtCrs = "EPSG:4326"
      }
    }]
    breakDataFrameLineage = true
    metadata.feed = ch
  }

  load-gld-ch-pp-raw-pmtiles {
    type = CopyAction
    inputId = slv-tlm3d-pp
    outputId = gld-ch-pp-raw-pmtiles
    transformers = [{
      type = SQLDfTransformer
      code = """
        select
          ST_Transform(ST_PointZ(x,y,z), '"""${parameters.defaultSrcCrs}"""', 'EPSG:4326') as geometry,
          concat(uuid_edge, '#', edge_idx) as token,
          position, uuid_edge, zoom,
          'pps' as layer
        from %{inputViewName} pp
      """
    }]
    breakDataFrameLineage = true
    metadata {
      feed = ch-disabled
      description = "Creates a pmtiles file, around 5GB size, takes ~15min including upload to S3"
    }
  }

  load-gld-ch-pp {
    type = CustomDataFrameAction
    inputIds = [slv-pp, slv-pp-mapping, slv-${parameters.topology}-pp]
    outputIds = [gld-ch-pp]
    transformers = [{
      type = SQLDfsTransformer
      code {
        gld-ch-pp = """
          select
            ST_PointZ(pp.x,pp.y,pp.z) as geometry,
            pp.id_positionpoint, pp.token, pp.zoom,
            ppm.uuid_edge, ppm.position, ppm.direction,
            org.azimuth,
            org.radius * ppm.direction as radius,
            org.grade * ppm.direction as grade,
            org.tags
          from %{inputViewName_slv-pp} pp
          join %{inputViewName_slv-pp-mapping} ppm using (id_positionpoint, zoom)
          left join %{inputViewName_slv-"""${parameters.topology}"""-pp} org using (uuid_edge, edge_idx)
        """
      }
    }]
    breakDataFrameLineage = true
    metadata {
      feed = ch
    }
  }

  load-gld-ch-pp-pmtiles {
    type = CustomDataFrameAction
    inputIds = [slv-pp, slv-pp-mapping, slv-${parameters.topology}-pp]
    outputIds = [gld-ch-pp-pmtiles]
    transformers = [{
      type = SQLDfsTransformer
      code {
        gld-ch-pp-pmtiles = """
          select
            ST_PointZ(pp.lng,pp.lat,pp.z) as geometry,
            pp.id_positionpoint, pp.token, pp.zoom,
            ppm.uuid_edge, ppm.position, ppm.direction,
            org.azimuth,
            org.radius * ppm.direction as radius,
            org.grade * ppm.direction as grade,
            org.tags,
            'pps' as layer
          from %{inputViewName_slv-pp} pp
          join %{inputViewName_slv-pp-mapping} ppm using (id_positionpoint, zoom)
          left join %{inputViewName_slv-"""${parameters.topology}"""-pp} org using (uuid_edge, edge_idx)
        """
      }
    }]
    breakDataFrameLineage = true
    metadata {
      feed = ch
      description = "Creates a pmtiles file, around 5GB size, takes 15min."
    }
  }


}